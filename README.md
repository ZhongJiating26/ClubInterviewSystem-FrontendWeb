# Club Interview System Backend

## ğŸ“‹ é¡¹ç›®ç®€ä»‹

è¿™æ˜¯ä¸€ä¸ªåŸºäº FastAPI + SQLModel + MySQL çš„æ ¡å›­ç¤¾å›¢æ‹›æ–°ä¸é¢è¯•ç®¡ç†ç³»ç»Ÿåç«¯ã€‚é¡¹ç›®é‡‡ç”¨ç°ä»£åŒ–çš„ Python Web å¼€å‘æ¶æ„ï¼Œæä¾›ç”¨æˆ·æ³¨å†Œã€ç™»å½•è®¤è¯ã€ç¤¾å›¢ç®¡ç†ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

#### âœ… è®¤è¯æ¨¡å—
- **ç”¨æˆ·æ³¨å†Œ** - æ‰‹æœºå· + å¯†ç æ³¨å†Œï¼Œè‡ªåŠ¨å“ˆå¸Œå¯†ç 
- **ç”¨æˆ·ç™»å½•** - æ‰‹æœºå· + å¯†ç ç™»å½•ï¼Œè¿”å› JWT Access Token
- **è´¦å·åˆå§‹åŒ–** - æ”¯æŒæœªåˆå§‹åŒ–è´¦å·ï¼ˆä»…æ‰‹æœºå·ï¼‰â†’ å®Œæ•´èµ„æ–™ï¼ˆå¯†ç  + å®åä¿¡æ¯ï¼‰
- **ç”¨æˆ·ä¿¡æ¯** - è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ (`/auth/me`)

#### âœ… å®‰å…¨ç‰¹æ€§
- **å¯†ç å®‰å…¨** - ä½¿ç”¨ bcrypt ç®—æ³•è‡ªåŠ¨åŠ ç›å“ˆå¸Œ
- **JWT è®¤è¯** - HS256 ç®—æ³•ï¼ŒPayload åŒ…å« `user_id` + `token_version`
- **ä»¤ç‰ŒåŠé”€** - é€šè¿‡ `token_version` å®ç°å¼ºåˆ¶ç™»å‡º/ä»¤ç‰Œå¤±æ•ˆ
- **çŠ¶æ€æ ¡éªŒ** - ç”¨æˆ·çŠ¶æ€ (`status`) å’Œè½¯åˆ é™¤ (`is_deleted`) åŒé‡æ ¡éªŒ

#### âœ… æ•°æ®æ¶æ„
- **è½¯åˆ é™¤æœºåˆ¶** - æ‰€æœ‰æ•°æ®è¡¨æ”¯æŒè½¯åˆ é™¤ï¼Œæ•°æ®å¯æ¢å¤
- **æ•°æ®åº“è¿ç§»** - ä½¿ç”¨ Alembic è¿›è¡Œç‰ˆæœ¬åŒ–æ•°æ®åº“ç®¡ç†
- **ä»“å‚¨æ¨¡å¼** - Repository æ¨¡å¼å°è£…æ•°æ®è®¿é—®é€»è¾‘
- **Pydantic éªŒè¯** - æ‰€æœ‰ API å‚æ•°å’Œå“åº”ä½¿ç”¨ Pydantic æ¨¡å‹éªŒè¯

## ğŸ—ï¸ æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **FastAPI** | - | å¼‚æ­¥ Web æ¡†æ¶ |
| **SQLModel** | - | ORM + Pydantic æ¨¡å‹ |
| **MySQL** | 8.0+ | å…³ç³»å‹æ•°æ®åº“ |
| **Alembic** | - | æ•°æ®åº“è¿ç§»å·¥å…· |
| **Passlib** | - | å¯†ç å“ˆå¸Œ (bcrypt) |
| **python-jose** | - | JWT ä»¤ç‰Œå¤„ç† |
| **Pydantic Settings** | - | é…ç½®ç®¡ç† |

## ğŸ“ é¡¹ç›®ç»“æ„

```
ClubInterviewSystem-Backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ deps.py              # FastAPI ä¾èµ–æ³¨å…¥ (JWT è®¤è¯)
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â””â”€â”€ auth.py          # è®¤è¯ API (æ³¨å†Œ/ç™»å½•/åˆå§‹åŒ–/ç”¨æˆ·ä¿¡æ¯)
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ config.py            # é…ç½®ç®¡ç† (Pydantic Settings)
â”‚   â”‚   â””â”€â”€ security.py          # JWT å·¥å…· (ç­¾å‘/è§£ç )
â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â””â”€â”€ session.py           # æ•°æ®åº“å¼•æ“ & Session å·¥å‚
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ base.py              # åŸºç¡€æ¨¡å‹ (è½¯åˆ é™¤/æ—¶é—´æˆ³/æ¢å¤æ–¹æ³•)
â”‚   â”‚   â”œâ”€â”€ school.py            # å­¦æ ¡è¡¨æ¨¡å‹
â”‚   â”‚   â””â”€â”€ user_account.py      # ç”¨æˆ·è´¦å·è¡¨æ¨¡å‹
â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”œâ”€â”€ base.py              # é€šç”¨ä»“å‚¨åŸºç±» (CRUD + è½¯åˆ é™¤)
â”‚   â”‚   â””â”€â”€ user_account.py      # ç”¨æˆ·ä»“å‚¨ (å¯†ç å“ˆå¸Œ/åˆå§‹åŒ–)
â”‚   â””â”€â”€ main.py                  # FastAPI åº”ç”¨å…¥å£ & è·¯ç”±æ³¨å†Œ
â”œâ”€â”€ alembic/
â”‚   â”œâ”€â”€ versions/                # æ•°æ®åº“è¿ç§»å†å²
â”‚   â”‚   â”œâ”€â”€ 7906d6cae979_create_school_table.py
â”‚   â”‚   â””â”€â”€ 9e13212a1495_create_user_account_table.py
â”‚   â””â”€â”€ env.py                   # Alembic é…ç½® (SQLModel é›†æˆ)
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ test_auth_init.py        # è´¦å·åˆå§‹åŒ–æµç¨‹æµ‹è¯•
â”œâ”€â”€ .env                         # ç¯å¢ƒå˜é‡é…ç½®
â””â”€â”€ tmp_test_user_repo.py        # ç”¨æˆ·ä»“å‚¨æµ‹è¯•è„šæœ¬
```

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### è¡¨ç»“æ„

#### 1. `user_account` ç”¨æˆ·è´¦å·è¡¨

```sql
-- æ ¸å¿ƒå­—æ®µ
id, phone, password_hash, token_version, status

-- ä¸ªäººä¿¡æ¯ (å¯ç©ºï¼Œåˆå§‹åŒ–æ—¶å¡«å†™)
name, id_card_no, school_id, major, student_no, avatar_url, email

-- è½¯åˆ é™¤ & æ—¶é—´æˆ³
is_deleted, deleted_at, created_at, updated_at

-- è®¤è¯ç›¸å…³
is_verified_campus, last_login_at
```

**å…³é”®è®¾è®¡ï¼š**
- âœ… **æ‰‹æœºå·å”¯ä¸€çº¦æŸ** - `(phone, is_deleted)` ç»„åˆå”¯ä¸€ï¼Œæ”¯æŒè½¯åˆ é™¤åé‡æ–°æ³¨å†Œ
- âœ… **å¯†ç å¯ä¸ºç©º** - `password_hash` å…è®¸ NULLï¼Œæ”¯æŒ"æœªåˆå§‹åŒ–è´¦å·"æ¨¡å¼
- âœ… **ä»¤ç‰Œç‰ˆæœ¬æ§åˆ¶** - `token_version` ç”¨äºå¼ºåˆ¶ç™»å‡º/ä»¤ç‰ŒåŠé”€
- âœ… **çŠ¶æ€åŒé‡æ ¡éªŒ** - `status` (ä¸šåŠ¡çŠ¶æ€) + `is_deleted` (è½¯åˆ é™¤)

**è´¦å·ç”Ÿå‘½å‘¨æœŸï¼š**
1. **æ³¨å†Œ** â†’ åˆ›å»ºè´¦å·ï¼Œ`password_hash = NULL`ï¼Œ`status = 1`
2. **åˆå§‹åŒ–** â†’ å¡«å†™å¯†ç  + å®åä¿¡æ¯ï¼Œ`password_hash` è®¾å€¼
3. **ç™»å½•** â†’ ä»…å½“ `password_hash != NULL` ä¸” `status = 1` æ—¶å…è®¸
4. **è½¯åˆ é™¤** â†’ `is_deleted = 1`ï¼Œæ•°æ®ä¿ç•™ä½†ä¸å¯è§

#### 2. `school` å­¦æ ¡è¡¨
```sql
id, name, code, province, city, status
-- è½¯åˆ é™¤ & æ—¶é—´æˆ³
is_deleted, deleted_at, created_at, updated_at
```

### è½¯åˆ é™¤è§„èŒƒ
æ‰€æœ‰ä¸šåŠ¡è¡¨ç»§æ‰¿ `BaseModel`ï¼ŒåŒ…å«ï¼š
- `is_deleted`: 0=æ­£å¸¸, 1=å·²åˆ é™¤
- `deleted_at`: åˆ é™¤æ—¶é—´
- `created_at`: åˆ›å»ºæ—¶é—´
- `updated_at`: æ›´æ–°æ—¶é—´
- `touch()`: æ›´æ–°æ—¶é—´æˆ³æ–¹æ³•
- `soft_delete()`: è½¯åˆ é™¤æ–¹æ³•
- `restore()`: æ¢å¤æ–¹æ³•

## ğŸ”„ æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### è´¦å·åˆå§‹åŒ–æµç¨‹ï¼ˆç‰¹è‰²åŠŸèƒ½ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·æ³¨å†Œ (POST /auth/register)                           â”‚
â”‚    â”œâ”€ è¾“å…¥: phone, password, name?, school_id?              â”‚
â”‚    â”œâ”€ è¡Œä¸º: åˆ›å»ºè´¦å·ï¼Œpassword_hash = NULL                  â”‚
â”‚    â””â”€ è¿”å›: {id, phone, name}                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å°è¯•ç™»å½• (POST /auth/login)                              â”‚
â”‚    â”œâ”€ æ£€æŸ¥: password_hash == NULL?                          â”‚
â”‚    â””â”€ è¿”å›: 403 "è´¦å·å°šæœªåˆå§‹åŒ–ï¼Œè¯·å…ˆå®Œå–„è´¦å·ä¿¡æ¯"           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ç”Ÿæˆä¸´æ—¶ Token (å†…éƒ¨)                                    â”‚
â”‚    â”œâ”€ ä½¿ç”¨: create_access_token(user_id, token_version)     â”‚
â”‚    â””â”€ ç›®çš„: è®©æœªåˆå§‹åŒ–ç”¨æˆ·ä¹Ÿèƒ½è®¿é—®åˆå§‹åŒ–æ¥å£                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. è´¦å·åˆå§‹åŒ– (POST /auth/init)                             â”‚
â”‚    â”œâ”€ éœ€æ±‚: Bearer Token + å®Œæ•´èµ„æ–™                         â”‚
â”‚    â”œâ”€ æ ¡éªŒ: å·²ç™»å½• + æœªåˆå§‹åŒ– + çŠ¶æ€æ­£å¸¸                    â”‚
â”‚    â”œâ”€ è¡Œä¸º: å†™å…¥ password_hash + å®åä¿¡æ¯                   â”‚
â”‚    â””â”€ è¿”å›: {message: "è´¦å·åˆå§‹åŒ–æˆåŠŸ"}                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æ­£å¸¸ç™»å½• (POST /auth/login)                              â”‚
â”‚    â”œâ”€ æ£€æŸ¥: password_hash != NULL + å¯†ç æ­£ç¡®                â”‚
â”‚    â”œâ”€ è¡Œä¸º: ç­¾å‘æ­£å¼ Token                                   â”‚
â”‚    â””â”€ è¿”å›: {access_token, token_type}                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### JWT è®¤è¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯è¯·æ±‚ API                                              â”‚
â”‚ Header: Authorization: Bearer <token>                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. decode_access_token()                                    â”‚
â”‚    â”œâ”€ éªŒè¯ç­¾å (HS256)                                      â”‚
â”‚    â”œâ”€ éªŒè¯è¿‡æœŸæ—¶é—´ (exp)                                    â”‚
â”‚    â””â”€ æå– payload: {user_id, token_version}                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. get_current_user_by_token()                              â”‚
â”‚    â”œâ”€ æŸ¥è¯¢æ•°æ®åº“: user = get_by_id(user_id)                 â”‚
â”‚    â”œâ”€ æ ¡éªŒ: is_deleted == 0                                 â”‚
â”‚    â”œâ”€ æ ¡éªŒ: status == 1                                     â”‚
â”‚    â””â”€ æ ¡éªŒ: token_version == user.token_version             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. é€šè¿‡éªŒè¯ï¼Œæ‰§è¡Œä¸šåŠ¡é€»è¾‘                                   â”‚
â”‚    è¿”å›: UserAccount å¯¹è±¡                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# æˆ–è€…ä½¿ç”¨ pip
pip install fastapi sqlmodel pymysql alembic passlib python-jose pydantic-settings uvicorn
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼ˆå·²å­˜åœ¨ï¼Œå¯ç›´æ¥ä¿®æ”¹ï¼‰ï¼š

```env
# ========== åŸºç¡€ ==========
APP_NAME=Club Interview System Backend
APP_ENV=dev
DEBUG=true

# ========== æ•°æ®åº“ ==========
DB_HOST=10.62.1.230
DB_PORT=3306
DB_USER=root
DB_PASSWORD=123456
DB_NAME=campus_club_interview

# ========== JWT ==========
JWT_SECRET_KEY=dev_secret_change_me
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7
```

### 3. æ•°æ®åº“è¿ç§»

```bash
# ç”Ÿæˆè¿ç§»æ–‡ä»¶ (è‡ªåŠ¨æ£€æµ‹æ¨¡å‹å˜æ›´)
alembic revision --autogenerate -m "æè¿°ä¿¡æ¯"

# æ‰§è¡Œè¿ç§»
alembic upgrade head

# å›æ»šè¿ç§»
alembic downgrade -1

# æŸ¥çœ‹å½“å‰ç‰ˆæœ¬
alembic current

# æŸ¥çœ‹è¿ç§»å†å²
alembic history
```

### 4. è¿è¡ŒæœåŠ¡

```bash
# å¼€å‘æ¨¡å¼è¿è¡Œ
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# æˆ–ä½¿ç”¨ python
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 5. æµ‹è¯• API

è®¿é—® Swagger UI:
```
http://localhost:8000/docs
```

## ğŸ“¡ API æ¥å£

### è®¤è¯æ¨¡å— (`/auth`)

#### 1. ç”¨æˆ·æ³¨å†Œ
```http
POST /auth/register
Content-Type: application/json

{
  "phone": "13800000001",
  "password": "123456",
  "name": "å¼ ä¸‰",
  "school_id": 1
}

# å“åº” (200)
{
  "id": 1,
  "phone": "13800000001",
  "name": "å¼ ä¸‰"
}

# é”™è¯¯ (400) - æ‰‹æœºå·å·²æ³¨å†Œ
{"detail": "æ‰‹æœºå·å·²æ³¨å†Œ"}
```

#### 2. ç”¨æˆ·ç™»å½•
```http
POST /auth/login
Content-Type: application/json

{
  "phone": "13800000001",
  "password": "123456"
}

# å“åº” (200)
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR...",
  "token_type": "bearer"
}

# é”™è¯¯ (400) - è´¦å·æˆ–å¯†ç é”™è¯¯
{"detail": "æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯"}

# é”™è¯¯ (403) - è´¦å·æœªåˆå§‹åŒ–
{"detail": "è´¦å·å°šæœªåˆå§‹åŒ–ï¼Œè¯·å…ˆå®Œå–„è´¦å·ä¿¡æ¯"}

# é”™è¯¯ (403) - ç”¨æˆ·è¢«ç¦ç”¨
{"detail": "ç”¨æˆ·å·²è¢«ç¦ç”¨"}
```

#### 3. è´¦å·åˆå§‹åŒ–
```http
POST /auth/init
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "password": "123456",
  "name": "æå››",
  "id_card_no": "110101199001011234",
  "school_id": 1,
  "major": "è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯",
  "student_no": "20230001",
  "email": "lisi@example.com",
  "avatar_url": "https://example.com/avatar.jpg"
}

# å“åº” (200)
{"message": "è´¦å·åˆå§‹åŒ–æˆåŠŸ"}

# é”™è¯¯ (401) - æœªç™»å½•
{"detail": "Not authenticated"}

# é”™è¯¯ (403) - ç”¨æˆ·è¢«ç¦ç”¨
{"detail": "ç”¨æˆ·å·²è¢«ç¦ç”¨"}

# é”™è¯¯ (409) - å·²åˆå§‹åŒ–
{"detail": "è´¦å·å·²åˆå§‹åŒ–ï¼Œæ— éœ€é‡å¤åˆå§‹åŒ–"}
```

#### 4. è·å–ç”¨æˆ·ä¿¡æ¯
```http
GET /auth/me
Authorization: Bearer <access_token>

# å“åº” (200)
{
  "id": 1,
  "phone": "13800000001",
  "name": "æå››",
  "status": 1
}
```

### å¥åº·æ£€æŸ¥

```http
GET /health

# å“åº”
{
  "status": "ok",
  "env": "dev"
}
```

## ğŸ” å®‰å…¨ç‰¹æ€§

### 1. å¯†ç å®‰å…¨
- **ç®—æ³•**ï¼šbcryptï¼Œè‡ªåŠ¨åŠ ç›ï¼Œé˜²æ­¢å½©è™¹è¡¨æ”»å‡»
- **åº“**ï¼špasslib.context.CryptContext
- **å­˜å‚¨**ï¼š`password_hash` å­—æ®µï¼Œæœ€å¤§é•¿åº¦ 255 å­—ç¬¦
- **éªŒè¯**ï¼š`verify_password(raw, hash)` å¯¹æ¯”å“ˆå¸Œå€¼

### 2. JWT è®¤è¯æµç¨‹
```python
# ç­¾å‘ (ç™»å½•æ—¶)
payload = {
    "user_id": user.id,
    "token_version": user.token_version,
    "exp": datetime.utcnow() + timedelta(minutes=30)
}
token = jwt.encode(payload, secret, algorithm="HS256")

# éªŒè¯ (æ¯æ¬¡è¯·æ±‚)
1. è§£ç  tokenï¼Œæ ¡éªŒç­¾åå’Œè¿‡æœŸæ—¶é—´
2. æŸ¥è¯¢ user_idï¼Œæ£€æŸ¥ is_deleted=0, status=1
3. å¯¹æ¯” token_versionï¼Œé˜²æ­¢ä»¤ç‰ŒåŠé”€åç»§ç»­ä½¿ç”¨
```

### 3. ä»¤ç‰ŒåŠé”€æœºåˆ¶
- **åœºæ™¯**ï¼šç”¨æˆ·ä¿®æ”¹å¯†ç ã€ä¸»åŠ¨ç™»å‡ºã€è´¦å·è¢«ç¦ç”¨
- **å®ç°**ï¼š`user.token_version += 1`
- **æ•ˆæœ**ï¼šæ‰€æœ‰æ—§ token è‡ªåŠ¨å¤±æ•ˆï¼ˆç‰ˆæœ¬ä¸åŒ¹é…ï¼‰

### 4. è´¦å·åˆå§‹åŒ–å®‰å…¨
- **æœªåˆå§‹åŒ–è´¦å·**ï¼š`password_hash = NULL`ï¼Œæ— æ³•ç™»å½•
- **åˆå§‹åŒ–è¦æ±‚**ï¼šå¿…é¡»å·²ç™»å½•ï¼ˆæœ‰æœ‰æ•ˆ tokenï¼‰
- **é˜²é‡å¤**ï¼šå·²åˆå§‹åŒ–è´¦å·æ— æ³•å†æ¬¡åˆå§‹åŒ– (409 Conflict)

### 5. æ•°æ®å®Œæ•´æ€§
- **å”¯ä¸€çº¦æŸ**ï¼š`(phone, is_deleted)` é˜²æ­¢é‡å¤æ³¨å†Œ
- **è½¯åˆ é™¤**ï¼šæ•°æ®ç‰©ç†ä¿ç•™ï¼Œé€»è¾‘éš”ç¦»
- **Pydantic éªŒè¯**ï¼šæ‰€æœ‰è¾“å…¥/è¾“å‡ºå­—æ®µä¸¥æ ¼æ ¡éªŒ

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°æ¨¡å‹

1. åœ¨ `app/models/` åˆ›å»ºæ¨¡å‹æ–‡ä»¶
2. ç»§æ‰¿ `BaseModel` è·å–è½¯åˆ é™¤èƒ½åŠ›
3. åœ¨ `app/models/__init__.py` å¯¼å…¥æ¨¡å‹
4. ç”Ÿæˆå¹¶æ‰§è¡Œè¿ç§»ï¼š
   ```bash
   alembic revision --autogenerate -m "add new table"
   alembic upgrade head
   ```

### æ·»åŠ æ–° API

1. åœ¨ `app/api/v1/` åˆ›å»ºè·¯ç”±æ–‡ä»¶
2. ä½¿ç”¨ `APIRouter` å®šä¹‰è·¯ç”±
3. åœ¨ `app/main.py` æ³¨å†Œè·¯ç”±ï¼š
   ```python
   from app.api.v1.new_module import router as new_router
   app.include_router(new_router)
   ```

### ä»“å‚¨æ¨¡å¼

æ‰€æœ‰æ•°æ®åº“æ“ä½œé€šè¿‡ Repository ç±»ï¼š

```python
from app.repositories.user_account import UserAccountRepository
from app.db.session import get_session

repo = UserAccountRepository()
user = repo.get_by_phone(session, phone)
```

## ğŸ§ª æµ‹è¯•

### å•å…ƒæµ‹è¯• (pytest)

ä½¿ç”¨ `tests/test_auth_init.py` æµ‹è¯•è´¦å·åˆå§‹åŒ–å®Œæ•´æµç¨‹ï¼š

```bash
# è¿è¡Œæµ‹è¯•
pytest tests/test_auth_init.py -v

# æµ‹è¯•è¦†ç›–ï¼š
# âœ… æœªç™»å½•ç›´æ¥ init â†’ 401
# âœ… æœªåˆå§‹åŒ–ç”¨æˆ·ç™»å½• â†’ 403
# âœ… ä½¿ç”¨ä¸´æ—¶ token åˆå§‹åŒ– â†’ 200
# âœ… é‡å¤åˆå§‹åŒ– â†’ 409
# âœ… åˆå§‹åŒ–åæ­£å¸¸ç™»å½• â†’ 200
```

### æ‰‹åŠ¨æµ‹è¯•è„šæœ¬

ä½¿ç”¨ `tmp_test_user_repo.py` æµ‹è¯•ç”¨æˆ·ä»“å‚¨ï¼š

```bash
python tmp_test_user_repo.py
```

### API æµ‹è¯•

ä½¿ç”¨ Swagger UI ç›´æ¥æµ‹è¯•ï¼š
1. è®¿é—® `http://localhost:8000/docs`
2. ç‚¹å‡» "Authorize" è¾“å…¥ Token
3. ç›´æ¥åœ¨é¡µé¢ä¸Šæµ‹è¯• API

**æµ‹è¯•å»ºè®®æµç¨‹ï¼š**
1. å…ˆè°ƒç”¨ `/auth/register` æ³¨å†Œè´¦å·
2. å°è¯• `/auth/login` â†’ åº”è¿”å› 403 (æœªåˆå§‹åŒ–)
3. ä»æ³¨å†Œå“åº”è·å– tokenï¼Œè°ƒç”¨ `/auth/init` å®Œæˆåˆå§‹åŒ–
4. å†æ¬¡ `/auth/login` â†’ åº”æˆåŠŸè¿”å› token
5. ä½¿ç”¨æ–° token è®¿é—® `/auth/me` éªŒè¯

## ğŸ“ å¼€å‘è§„èŒƒ

### ä»£ç é£æ ¼
- ä½¿ç”¨ç±»å‹æ³¨è§£
- éµå¾ª PEP 8
- å‡½æ•°å’Œç±»è¦æœ‰æ–‡æ¡£å­—ç¬¦ä¸²
- ä¸­æ–‡æ³¨é‡Šè¯´æ˜ä¸šåŠ¡é€»è¾‘

### Git æäº¤è§„èŒƒ
```
feat: æ–°åŠŸèƒ½
fix: ä¿®å¤ bug
docs: æ–‡æ¡£æ›´æ–°
refactor: ä»£ç é‡æ„
test: æµ‹è¯•ç›¸å…³
chore: æ„å»º/å·¥å…·å˜åŠ¨
```

### åˆ†æ”¯ç®¡ç†
- `main`: ä¸»åˆ†æ”¯ï¼Œç¨³å®šç‰ˆæœ¬
- `develop`: å¼€å‘åˆ†æ”¯
- `feature/xxx`: åŠŸèƒ½åˆ†æ”¯

## ğŸ”§ å¸¸è§é—®é¢˜

### Q: ç™»å½•æ—¶è¿”å› "è´¦å·å°šæœªåˆå§‹åŒ–" æ€ä¹ˆåŠï¼Ÿ
**A:** è¿™æ˜¯é¡¹ç›®çš„ç‰¹è‰²åŠŸèƒ½ã€‚æ³¨å†Œåè´¦å·å¤„äº"æœªåˆå§‹åŒ–"çŠ¶æ€ï¼š
1. æ³¨å†Œæ—¶ä¼šè¿”å›ç”¨æˆ·ä¿¡æ¯ï¼Œä½†**ä¸ä¼š**è¿”å› token
2. éœ€è¦å…ˆé€šè¿‡å…¶ä»–æ–¹å¼ï¼ˆå¦‚ç®¡ç†å‘˜åˆ†é…ï¼‰è·å¾—ä¸´æ—¶ token
3. ä½¿ç”¨ token è°ƒç”¨ `/auth/init` å®Œæˆåˆå§‹åŒ–
4. åˆå§‹åŒ–åæ‰èƒ½æ­£å¸¸ç™»å½•

**å¼€å‘ç¯å¢ƒæµ‹è¯•ï¼š**
```python
# åœ¨ä»£ç ä¸­æ‰‹åŠ¨åˆ›å»ºä¸´æ—¶ token
from app.core.security import create_access_token
token = create_access_token(
    subject={"user_id": user.id, "token_version": user.token_version}
)
```

### Q: å¦‚ä½•é‡ç½®æ•°æ®åº“ï¼Ÿ
```bash
# å›æ»šæ‰€æœ‰è¿ç§»
alembic downgrade base

# é‡æ–°æ‰§è¡Œæ‰€æœ‰è¿ç§»
alembic upgrade head
```

### Q: å¦‚ä½•æŸ¥çœ‹ SQL è¯­å¥ï¼Ÿ
åœ¨ `.env` ä¸­è®¾ç½®ï¼š
```env
DEBUG=true
```
SQL è¯­å¥å°†åœ¨æ§åˆ¶å°è¾“å‡ºã€‚

### Q: å¦‚ä½•ä¿®æ”¹ JWT è¿‡æœŸæ—¶é—´ï¼Ÿ
ä¿®æ”¹ `app/core/config.py`ï¼š
```python
jwt_expire_minutes: int = Field(60 * 24)  # 1å¤©
access_token_expire_minutes: int = 30
```

### Q: ä¸ºä»€ä¹ˆæ³¨å†Œæ¥å£ä¸ç›´æ¥è¿”å› tokenï¼Ÿ
**A:** è¿™æ˜¯ä¸šåŠ¡è®¾è®¡ã€‚æ³¨å†Œæ—¶å¯èƒ½ï¼š
- åªæ”¶é›†æ‰‹æœºå·ï¼Œåç»­éœ€è¦å®Œå–„èµ„æ–™
- éœ€è¦ç®¡ç†å‘˜å®¡æ ¸
- éœ€è¦å‘é€éªŒè¯ç éªŒè¯

é€šè¿‡"æœªåˆå§‹åŒ–"çŠ¶æ€ï¼Œå¯ä»¥çµæ´»æ§åˆ¶è´¦å·ç”Ÿå‘½å‘¨æœŸã€‚

### Q: å¦‚ä½•å®ç°ä»¤ç‰ŒåŠé”€ï¼ˆå¼ºåˆ¶ç™»å‡ºï¼‰ï¼Ÿ
**A:** åœ¨éœ€è¦å¼ºåˆ¶ç™»å‡ºçš„åœ°æ–¹ï¼ˆä¿®æ”¹å¯†ç ã€è´¦å·ç¦ç”¨ï¼‰ï¼š
```python
user.token_version += 1
session.commit()
```
æ‰€æœ‰æ—§ token å› ç‰ˆæœ¬ä¸åŒ¹é…è‡ªåŠ¨å¤±æ•ˆã€‚

### Q: è´¦å·åˆå§‹åŒ–æ¥å£éœ€è¦è®¤è¯ï¼Œæœªåˆå§‹åŒ–ç”¨æˆ·æ€ä¹ˆæ‹¿åˆ° tokenï¼Ÿ
**A:** ä¸¤ç§æ–¹æ¡ˆï¼š
1. **å¼€å‘ç¯å¢ƒ**ï¼šæ‰‹åŠ¨åˆ›å»ºä¸´æ—¶ tokenï¼ˆè§ä¸Šæ–‡ï¼‰
2. **ç”Ÿäº§ç¯å¢ƒ**ï¼šé€šè¿‡çŸ­ä¿¡éªŒè¯ç æˆ–å…¶ä»–è®¤è¯æ–¹å¼ï¼Œç”Ÿæˆä¸€æ¬¡æ€§åˆå§‹åŒ– token

## ğŸ“š ä¾èµ–è¯´æ˜

### æ ¸å¿ƒä¾èµ–
- **fastapi**: å¼‚æ­¥ Web æ¡†æ¶ï¼Œè‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£
- **sqlmodel**: SQLModel = SQLAlchemy + Pydanticï¼Œç®€åŒ– ORM
- **pymysql**: MySQL æ•°æ®åº“é©±åŠ¨
- **alembic**: æ•°æ®åº“è¿ç§»å·¥å…·
- **passlib**: å¯†ç å“ˆå¸Œåº“ (bcrypt)
- **python-jose**: JWT ä»¤ç‰Œå¤„ç†
- **pydantic-settings**: ç¯å¢ƒå˜é‡é…ç½®ç®¡ç†
- **uvicorn**: ASGI æœåŠ¡å™¨

## ğŸ¯ ä¸‹ä¸€æ­¥å¼€å‘è®¡åˆ’

### âœ… å·²å®ŒæˆåŠŸèƒ½
- [x] ç”¨æˆ·æ³¨å†Œ/ç™»å½•/åˆå§‹åŒ–åŸºç¡€æµç¨‹
- [x] JWT è®¤è¯ä¸ä»¤ç‰ŒåŠé”€æœºåˆ¶
- [x] è½¯åˆ é™¤ä¸æ•°æ®æ¢å¤
- [x] æ•°æ®åº“è¿ç§» (Alembic)
- [x] è´¦å·åˆå§‹åŒ–æµç¨‹æµ‹è¯•

### ğŸ“‹ å¾…å¼€å‘åŠŸèƒ½
- [ ] **ç¤¾å›¢ç®¡ç†æ¨¡å—** - ç¤¾å›¢åˆ›å»ºã€æˆå‘˜ç®¡ç†ã€æ‹›æ–°è®¾ç½®
- [ ] **æ‹›æ–°æµç¨‹ç®¡ç†** - æŠ¥åè¡¨å•ã€å®¡æ ¸æµç¨‹ã€çŠ¶æ€è·Ÿè¸ª
- [ ] **é¢è¯•å®‰æ’åŠŸèƒ½** - é¢è¯•æ—¶é—´è¡¨ã€é¢è¯•å®˜åˆ†é…ã€ç»“æœå½•å…¥
- [ ] **æƒé™æ§åˆ¶ (RBAC)** - è§’è‰²ç®¡ç† (ç®¡ç†å‘˜/ç¤¾é•¿/æˆå‘˜/ç”³è¯·äºº)
- [ ] **æ–‡ä»¶ä¸Šä¼ ** - å¤´åƒã€èº«ä»½è¯ã€å­¦ç”Ÿè¯ä¸Šä¼  (OSS/æœ¬åœ°)
- [ ] **çŸ­ä¿¡éªŒè¯ç ** - æ‰‹æœºå·éªŒè¯ã€ç™»å½•/æ³¨å†ŒéªŒè¯ç 
- [ ] **API é™æµ** - é˜²æ­¢åˆ·æ¥å£ã€DDoS é˜²æŠ¤
- [ ] **æ—¥å¿—ç³»ç»Ÿ** - æ“ä½œæ—¥å¿—ã€å®¡è®¡æ—¥å¿—
- [ ] **å•å…ƒæµ‹è¯•** - è¦†ç›–ç‡æå‡åˆ° 80%+
- [ ] **ç¼“å­˜ä¼˜åŒ–** - Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®
- [ ] **WebSocket** - å®æ—¶é€šçŸ¥ã€é¢è¯•çŠ¶æ€æ¨é€

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œå†…éƒ¨ä½¿ç”¨ã€‚

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
- æäº¤ Issue
- å‘é€é‚®ä»¶
- åˆ›å»º Pull Request

---

**å¼€å‘çŠ¶æ€**: âœ… åŸºç¡€æ¶æ„å®Œæˆï¼Œæ ¸å¿ƒåŠŸèƒ½å¯ç”¨