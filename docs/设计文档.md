# 设计文档

## 1. 系统架构

### 1.1 技术栈

#### 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **Next.js** | 14.2+ | React 框架，App Router，服务端渲染 |
| **TypeScript** | 5.5+ | 静态类型检查，保障代码健壮性 |
| **Tailwind CSS** | 3.4+ | 原子化 CSS，构建现代 UI |
| **Shadcn/ui** | - | 基于 Radix UI 的高质量组件库 |
| **Axios** | 1.7+ | HTTP 客户端，API 请求 |
| **React Hook Form** | 7.5+ | 表单管理和验证 |
| **Zod** | 3.23+ | 类型安全的 Schema 验证 |

#### 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **FastAPI** | - | 异步 Web 框架 |
| **SQLModel** | - | ORM + Pydantic 模型 |
| **SQLite** | - | 轻量级关系型数据库（Python内置） |
| **Alembic** | - | 数据库迁移工具 |
| **Passlib** | - | 密码哈希 (bcrypt) |
| **python-jose** | - | JWT 令牌处理 |
| **Pydantic Settings** | - | 环境变量配置管理 |
| **uvicorn** | - | ASGI 服务器 |

### 1.2 系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                     前端 (Next.js)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │   Pages      │  │  Components  │  │     Lib      │  │
│  │  (App Router)│  │  (UI/业务)   │  │  (API/Auth)  │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└───────────────────────┬─────────────────────────────────┘
                        │ HTTP/REST API
                        │ (JWT Token)
┌───────────────────────▼─────────────────────────────────┐
│                   后端 (FastAPI)                         │
│  ┌──────────────────────────────────────────────────┐   │
│  │      Router Layer (API路由层)                    │   │
│  │   - 处理HTTP请求                                 │   │
│  │   - 参数验证                                     │   │
│  │   - 响应格式化                                   │   │
│  └──────────────┬───────────────────────────────────┘   │
│                 │                                        │
│  ┌──────────────▼───────────────────────────────────┐   │
│  │      Service Layer (业务逻辑层)                  │   │
│  │   - 业务逻辑封装                                 │   │
│  │   - 事务管理                                     │   │
│  │   - 权限检查                                     │   │
│  └──────────────┬───────────────────────────────────┘   │
│                 │                                        │
│  ┌──────────────▼───────────────────────────────────┐   │
│  │   Repository Layer (数据访问层)                  │   │
│  │   - CRUD操作                                     │   │
│  │   - 数据查询                                     │   │
│  │   - 软删除处理                                   │   │
│  └──────────────┬───────────────────────────────────┘   │
│                 │                                        │
│  ┌──────────────▼───────────────────────────────────┐   │
│  │      Model Layer (数据模型层)                    │   │
│  │   - SQLModel模型定义                            │   │
│  │   - 表结构定义                                  │   │
│  └──────────────┬───────────────────────────────────┘   │
└─────────────────┼───────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────┐
│                  SQLite 数据库                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │  用户表  │  │  社团表  │  │  招新表  │  │  其他表  │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 1.3 前后端通信

- **协议**: HTTP/HTTPS
- **数据格式**: JSON
- **认证方式**: JWT Bearer Token
- **API 风格**: RESTful
- **跨域处理**: Next.js Rewrites 或 CORS

### 1.4 项目结构

```
ClubInterviewSystem/
├── frontend/                    # 前端项目
│   ├── app/                     # Next.js App Router
│   │   ├── layout.tsx          # 根布局
│   │   ├── page.tsx            # 首页
│   │   ├── login/              # 登录页
│   │   ├── register/           # 注册页
│   │   ├── dashboard/          # 仪表盘
│   │   ├── clubs/              # 社团管理
│   │   ├── recruitments/       # 招新管理
│   │   └── applications/       # 申请管理
│   ├── components/             # React 组件
│   │   ├── ui/                 # UI 组件库 (Shadcn/ui)
│   │   └── providers.tsx       # 全局 Provider
│   ├── lib/                    # 工具函数
│   │   ├── api.ts              # API 客户端
│   │   ├── auth.ts             # 认证相关
│   │   └── utils.ts            # 工具函数
│   ├── public/                 # 静态资源
│   ├── package.json
│   └── tsconfig.json
│
└── app/                        # 后端项目 (当前在根目录)
    ├── api/                    # API路由层
    │   ├── deps.py             # FastAPI 依赖注入 (JWT 认证)
    │   ├── deps_permission.py  # 权限检查依赖
    │   └── v1/
    │       ├── auth.py         # 认证 API
    │       ├── club.py          # 社团管理 API
    │       ├── recruitment.py  # 招新管理 API
    │       └── dict.py          # 字典数据 API
    ├── core/                   # 核心配置
    ├── db/                     # 数据库
    ├── models/                 # 数据模型层
    ├── repositories/           # 数据访问层
    ├── services/               # 业务逻辑层
    ├── schemas/                # Pydantic Schema
    └── main.py                 # FastAPI 应用入口
├── alembic/                    # 数据库迁移
├── tests/                      # 测试
└── docs/                       # 文档
    ├── 设计文档.md
    └── 使用手册.md
```

## 2. 数据库设计

### 2.1 表结构

#### 用户账号表 (`user_account`)

```sql
-- 核心字段
id, phone, password_hash, token_version, status

-- 个人信息 (可空，初始化时填写)
name, id_card_no, school_id, major, student_no, avatar_url, email

-- 软删除 & 时间戳
is_deleted, deleted_at, created_at, updated_at

-- 认证相关
is_verified_campus, last_login_at

-- 唯一约束
UNIQUE (phone, is_deleted)
```

**关键设计：**
- 手机号唯一约束：`(phone, is_deleted)` 组合唯一，支持软删除后重新注册
- 密码可为空：`password_hash` 允许 NULL，支持"未初始化账号"模式
- 令牌版本控制：`token_version` 用于强制登出/令牌吊销
- 状态双重校验：`status` (业务状态) + `is_deleted` (软删除)

#### 学校表 (`school`)

```sql
id, name, code, province, city, status
is_deleted, deleted_at, created_at, updated_at
```

#### 社团表 (`club`)

```sql
-- 基本信息
id, name, description, logo_url, cover_url
-- 关联信息
school_id, president_id
-- 状态与统计
status, member_count
-- 软删除 & 时间戳
is_deleted, deleted_at, created_at, updated_at
```

#### 社团成员表 (`club_member`)

```sql
id, club_id, user_id, role, status
is_deleted, deleted_at, created_at, updated_at
```

#### 招新活动表 (`recruitment`)

```sql
-- 基本信息
id, club_id, title, description
-- 时间信息
start_time, end_time, interview_start_time, interview_end_time
-- 状态与统计
status, application_count
-- 软删除 & 时间戳
is_deleted, deleted_at, created_at, updated_at
```

#### 报名申请表 (`application`)

```sql
-- 关联信息
id, recruitment_id, user_id
-- 申请信息
motivation, experience, skills
-- 状态
status (0待审核 1已通过 2已拒绝 3已取消)
-- 审核信息
reviewed_by, reviewed_at, review_comment
-- 软删除 & 时间戳
is_deleted, deleted_at, created_at, updated_at
```

#### 面试安排表 (`interview`)

```sql
-- 关联信息
id, application_id, interviewer_id
-- 面试信息
scheduled_time, duration, location
-- 状态
status (0待面试 1进行中 2已完成 3已取消)
-- 面试结果
result, score, comment, completed_at
-- 软删除 & 时间戳
is_deleted, deleted_at, created_at, updated_at
```

#### RBAC 权限表

- `role` - 角色表
- `permission` - 权限表
- `user_role` - 用户角色关联表
- `role_permission` - 角色权限关联表

### 2.2 软删除规范

所有业务表继承 `BaseModel`，包含：
- `is_deleted`: 0=正常, 1=已删除
- `deleted_at`: 删除时间
- `created_at`: 创建时间
- `updated_at`: 更新时间
- `touch()`: 更新时间戳方法
- `soft_delete()`: 软删除方法
- `restore()`: 恢复方法

## 3. 核心业务流程

### 3.1 账号初始化流程

```
1. 用户注册 (POST /auth/register)
   ↓
2. 账号存在（password_hash = NULL，未初始化）
   ↓
3. 通过 JWT 保持登录态
   ↓
4. 账号初始化 (POST /auth/init)
   ↓
5. 正式登录 (POST /auth/login)
```

### 3.2 招新完整流程

```
1. 社长创建招新活动
   ↓
2. 发布招新活动（状态：进行中）
   ↓
3. 用户提交报名申请
   ↓
4. 社长审核申请（通过/拒绝）
   ↓
5. 为通过的申请安排面试
   ↓
6. 面试官完成面试并录入结果
   ↓
7. 根据面试结果决定是否录取
```

### 3.3 JWT 认证流程

```
客户端请求 API (Header: Authorization: Bearer <token>)
   ↓
1. decode_access_token() - 验证签名和过期时间
   ↓
2. get_current_user_by_token() - 查询用户并校验
   ↓
3. 校验: is_deleted == 0, status == 1, token_version 匹配
   ↓
4. 通过验证，执行业务逻辑
```

### 3.4 权限控制流程

```
用户请求 → JWT认证 → 获取用户角色 → 检查权限 → 执行业务逻辑
```

## 4. 安全特性

### 4.1 密码安全

- **算法**：bcrypt，自动加盐，防止彩虹表攻击
- **存储**：`password_hash` 字段，最大长度 255 字符
- **验证**：`verify_password(raw, hash)` 对比哈希值

### 4.2 JWT 认证

- **算法**：HS256
- **Payload**：`user_id` + `token_version` + `exp`
- **验证**：签名校验、过期校验、版本校验

### 4.3 令牌吊销机制

- **场景**：用户修改密码、主动登出、账号被禁用
- **实现**：`user.token_version += 1`
- **效果**：所有旧 token 自动失效（版本不匹配）

### 4.4 数据完整性

- **唯一约束**：`(phone, is_deleted)` 防止重复注册
- **软删除**：数据物理保留，逻辑隔离
- **Pydantic 验证**：所有输入/输出字段严格校验

## 5. API 设计

### 5.1 RESTful 规范

- 使用标准 HTTP 方法：GET、POST、PUT、DELETE
- 资源命名使用复数形式：`/clubs`、`/recruitments`
- 状态码：200 成功、201 创建、400 错误、401 未授权、403 禁止、404 不存在

### 5.2 认证方式

所有需要认证的接口使用 Bearer Token：

```
Authorization: Bearer <access_token>
```

### 5.3 响应格式

**成功响应：**
```json
{
  "id": 1,
  "name": "示例"
}
```

**错误响应：**
```json
{
  "detail": "错误信息"
}
```

## 6. 前端架构

### 6.1 页面路由

使用 Next.js App Router：

- `/` - 首页（自动跳转）
- `/login` - 登录页
- `/register` - 注册页
- `/dashboard` - 仪表盘
- `/clubs` - 社团列表
- `/clubs/[id]` - 社团详情
- `/recruitments` - 招新列表
- `/recruitments/[id]` - 招新详情
- `/applications` - 我的申请

### 6.2 组件结构

```
components/
├── ui/              # Shadcn/ui 基础组件
│   ├── button.tsx
│   ├── card.tsx
│   ├── dialog.tsx
│   └── ...
├── layout/          # 布局组件
│   ├── header.tsx
│   ├── sidebar.tsx
│   └── footer.tsx
└── features/        # 业务组件
    ├── club/
    ├── recruitment/
    └── ...
```

### 6.3 状态管理

- **服务端状态**: 使用 React Server Components + API 调用
- **客户端状态**: 使用 React Hooks (useState, useEffect)
- **表单状态**: 使用 React Hook Form + Zod 验证

### 6.4 样式方案

- **Tailwind CSS**: 原子化 CSS，快速构建 UI
- **Shadcn/ui**: 基于 Radix UI 的组件库
- **响应式设计**: 移动端优先，支持多设备

## 7. 开发规范

### 7.1 代码风格

- 使用类型注解
- 遵循 PEP 8
- 函数和类要有文档字符串
- 中文注释说明业务逻辑

### 7.2 Git 提交规范

```
feat: 新功能
fix: 修复 bug
docs: 文档更新
refactor: 代码重构
test: 测试相关
chore: 构建/工具变动
```

### 7.3 分支管理

- `main`: 主分支，稳定版本
- `develop`: 开发分支
- `feature/xxx`: 功能分支

