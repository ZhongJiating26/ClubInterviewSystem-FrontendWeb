# 使用手册

## 1. 环境配置

### 1.1 后端配置

#### 安装依赖

```bash
cd backend  # 如果后端在单独目录
pip install -r requirements.txt
```

#### 环境变量配置

创建 `.env` 文件：

```env
# ========== 基础 ==========
APP_NAME=Club Interview System Backend
APP_ENV=dev
DEBUG=true

# ========== 数据库 (SQLite) ==========
# 数据库文件名，会保存在项目根目录
DB_NAME=club_interview.db

# ========== JWT ==========
JWT_SECRET_KEY=your-secret-key-change-this-in-production
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7
```

#### 数据库迁移

```bash
# 生成迁移文件 (自动检测模型变更)
alembic revision --autogenerate -m "描述信息"

# 执行迁移（创建所有表）
alembic upgrade head

# 查看当前版本
alembic current

# 查看迁移历史
alembic history

# 回滚迁移（如需要）
alembic downgrade -1
```

#### 创建预制账号

系统提供了预制账号创建脚本，用于快速创建测试账号：

```bash
cd backend
python scripts/create_default_users.py
```

**预制账号信息：**

| 账号类型 | 手机号 | 密码 | 姓名 | 角色 |
|---------|--------|------|------|------|
| 普通学生 | 13800000001 | student123 | 张三 | 普通学生 |
| 系统管理员 | 13800000000 | admin123 | 系统管理员 | 系统管理员 |

**注意事项：**
- 这些账号仅用于开发和测试环境
- 生产环境请及时修改密码或删除这些账号
- 如果账号已存在，脚本会跳过创建，不会报错

#### 启动后端服务

```bash
# 开发模式运行
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# 或使用 python
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 1.2 前端配置

#### 安装依赖

```bash
cd frontend
npm install
# 或
yarn install
# 或
pnpm install
```

#### 环境变量配置

创建 `.env.local` 文件：

```env
NEXT_PUBLIC_API_URL=http://localhost:8000
```

#### 启动前端服务

```bash
npm run dev
# 或
yarn dev
# 或
pnpm dev
```

访问 http://localhost:3000

#### 构建生产版本

```bash
npm run build
npm start
```

## 2. 预制账号

### 2.1 创建预制账号

系统提供了预制账号创建脚本，用于快速创建测试账号。这些账号可以帮助你快速开始测试系统功能。

#### 运行脚本

```bash
cd backend
python scripts/create_default_users.py
```

#### 预制账号信息

脚本会创建以下两个账号：

**1. 普通学生账号**
- **手机号**: `13800000001`
- **密码**: `student123`
- **姓名**: 张三
- **角色**: 普通学生
- **用途**: 用于测试普通用户功能，如报名、查看申请等

**2. 系统管理员账号**
- **手机号**: `13800000000`
- **密码**: `admin123`
- **姓名**: 系统管理员
- **角色**: 系统管理员
- **用途**: 用于测试管理员功能，如审核申请、管理社团等

#### 注意事项

⚠️ **重要提示**：
- 这些账号**仅用于开发和测试环境**
- **生产环境请及时修改密码或删除这些账号**
- 如果账号已存在，脚本会跳过创建，不会报错
- 脚本会自动创建管理员角色并分配给管理员账号

#### 使用预制账号登录

1. 启动前后端服务
2. 访问 http://localhost:3000/login
3. 使用上述账号信息登录
4. 登录成功后即可使用系统功能

### 2.2 修改预制账号密码

如果需要修改预制账号的密码，可以通过以下方式：

**方式一：通过前端修改密码**
1. 使用预制账号登录
2. 访问账号设置页面
3. 使用"修改密码"功能

**方式二：通过 API 修改密码**
```http
POST /auth/change-password
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "old_password": "student123",
  "new_password": "新密码"
}
```

## 3. 前端使用

### 3.1 页面导航

- **首页** (`/`) - 自动跳转到登录或仪表盘
- **登录页** (`/login`) - 用户登录
- **注册页** (`/register`) - 用户注册
- **仪表盘** (`/dashboard`) - 主控制面板
- **社团管理** (`/clubs`) - 查看和管理社团
- **招新管理** (`/recruitments`) - 管理招新活动
- **我的申请** (`/applications`) - 查看我的申请

### 3.2 功能使用

#### 用户注册

1. 访问 `/register`
2. 填写手机号、密码等信息
3. 点击注册
4. 注册成功后跳转到登录页

#### 用户登录

1. 访问 `/login`
2. 输入手机号和密码
3. 点击登录
4. 登录成功后跳转到仪表盘

#### 账号初始化

注册后需要初始化账号：
1. 登录后访问账号设置
2. 填写完整信息（姓名、身份证、学校等）
3. 设置密码
4. 完成初始化

## 4. API 接口使用

### 4.1 认证模块 (`/auth`)

#### 用户注册

```http
POST /auth/register
Content-Type: application/json

{
  "phone": "13800000001",
  "password": "123456",
  "name": "张三",
  "school_id": 1
}
```

**响应：**
```json
{
  "id": 1,
  "phone": "13800000001",
  "name": "张三"
}
```

#### 用户登录

```http
POST /auth/login
Content-Type: application/json

{
  "phone": "13800000001",
  "password": "123456"
}
```

**响应：**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR...",
  "token_type": "bearer"
}
```

#### 账号初始化

```http
POST /auth/init
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "password": "123456",
  "name": "李四",
  "id_card_no": "110101199001011234",
  "school_id": 1,
  "major": "计算机科学与技术",
  "student_no": "20230001",
  "email": "lisi@example.com",
  "avatar_url": "https://example.com/avatar.jpg"
}
```

#### 获取用户信息

```http
GET /auth/me
Authorization: Bearer <access_token>
```

#### 修改密码

```http
POST /auth/change-password
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "old_password": "123456",
  "new_password": "newpassword123"
}
```

### 4.2 社团管理模块 (`/clubs`)

#### 创建社团

```http
POST /clubs
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "name": "计算机协会",
  "description": "致力于计算机技术交流",
  "school_id": 1,
  "logo_url": "https://example.com/logo.jpg",
  "cover_url": "https://example.com/cover.jpg"
}
```

#### 获取社团列表

```http
GET /clubs?school_id=1&keyword=计算机&offset=0&limit=20
```

#### 获取社团详情

```http
GET /clubs/{club_id}
```

#### 更新社团信息（仅社长）

```http
PUT /clubs/{club_id}
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "name": "新名称",
  "description": "新描述"
}
```

#### 添加成员（仅社长）

```http
POST /clubs/{club_id}/members
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "user_id": 2,
  "role": "member"
}
```

#### 获取成员列表

```http
GET /clubs/{club_id}/members
```

### 4.3 招新管理模块 (`/recruitments`)

#### 创建招新活动（仅社长）

```http
POST /recruitments
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "club_id": 1,
  "title": "2024春季招新",
  "description": "欢迎加入我们",
  "start_time": "2024-03-01T00:00:00",
  "end_time": "2024-03-31T23:59:59",
  "interview_start_time": "2024-04-01T00:00:00",
  "interview_end_time": "2024-04-15T23:59:59"
}
```

#### 发布招新活动（仅社长）

```http
POST /recruitments/{recruitment_id}/publish
Authorization: Bearer <access_token>
```

#### 创建报名申请

```http
POST /recruitments/applications
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "recruitment_id": 1,
  "motivation": "我对计算机技术很感兴趣",
  "experience": "有Python开发经验",
  "skills": "Python, FastAPI"
}
```

#### 审核申请（仅社长）

```http
POST /recruitments/applications/{application_id}/review
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "approved": true,
  "comment": "通过审核"
}
```

#### 创建面试安排（仅社长）

```http
POST /recruitments/interviews
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "application_id": 1,
  "interviewer_id": 1,
  "scheduled_time": "2024-04-10T14:00:00",
  "duration": 30,
  "location": "教学楼A101"
}
```

#### 完成面试（仅面试官）

```http
POST /recruitments/interviews/{interview_id}/complete
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "result": 1,
  "score": 85.5,
  "comment": "表现优秀，通过面试"
}
```

### 4.4 字典数据模块 (`/dict`)

#### 获取学校列表

```http
GET /dict/schools?province=北京&city=北京&keyword=清华
```

#### 获取专业列表

```http
GET /dict/majors?school_id=1&keyword=计算机
```

## 5. 开发指南

### 5.1 后端开发

#### 添加新模型

1. 在 `app/models/` 创建模型文件
2. 继承 `BaseModel` 获取软删除能力
3. 在 `app/models/__init__.py` 导入模型
4. 生成并执行迁移：
   ```bash
   alembic revision --autogenerate -m "add new table"
   alembic upgrade head
   ```

#### 添加新 API

1. 在 `app/api/v1/` 创建路由文件
2. 使用 `APIRouter` 定义路由
3. 在 `app/main.py` 注册路由：
   ```python
   from app.api.v1.new_module import router as new_router
   app.include_router(new_router)
   ```

#### 服务层架构

项目采用**服务层架构**，业务逻辑封装在 Service 层：

```python
from app.services.auth_service import AuthService
from app.db.session import get_session

auth_service = AuthService()
user = auth_service.register(session, phone="13800000001", password="123456")
```

**架构层次：**
1. **Router层** - 处理HTTP请求，参数验证
2. **Service层** - 封装业务逻辑
3. **Repository层** - 数据访问，CRUD操作
4. **Model层** - 数据模型定义

#### 仓储模式

所有数据库操作通过 Repository 类：

```python
from app.repositories.user_account import UserAccountRepository
from app.db.session import get_session

repo = UserAccountRepository()
user = repo.get_by_phone(session, phone)
```

### 5.2 前端开发

#### 添加新页面

在 `app/` 目录下创建新目录和 `page.tsx`：

```typescript
// app/new-page/page.tsx
export default function NewPage() {
  return <div>新页面</div>;
}
```

#### 使用 API

```typescript
import { api } from "@/lib/api";

// GET 请求
const response = await api.get("/clubs");
const clubs = response.data;

// POST 请求
const response = await api.post("/clubs", {
  name: "新社团",
  school_id: 1,
});
```

#### 使用 UI 组件

```typescript
import { Button } from "@/components/ui/button";

<Button variant="default" size="lg">
  点击我
</Button>
```

## 6. 测试

### 6.1 后端单元测试 (pytest)

```bash
# 运行测试
pytest tests/test_auth_init.py -v
```

### 6.2 API 测试

使用 Swagger UI 直接测试：
1. 访问 `http://localhost:8000/docs`
2. 点击 "Authorize" 输入 Token
3. 直接在页面上测试 API

**测试建议流程：**
1. 先调用 `/auth/register` 注册账号
2. 尝试 `/auth/login` → 应返回 403 (未初始化)
3. 从注册响应获取 token，调用 `/auth/init` 完成初始化
4. 再次 `/auth/login` → 应成功返回 token
5. 使用新 token 访问 `/auth/me` 验证

## 7. 常见问题

### Q: 登录时返回 "账号尚未初始化" 怎么办？

**A:** 这是项目的特色功能。注册后账号处于"未初始化"状态：
1. 注册时会返回用户信息，但**不会**返回 token
2. 需要先通过其他方式（如管理员分配）获得临时 token
3. 使用 token 调用 `/auth/init` 完成初始化
4. 初始化后才能正常登录

**开发环境测试：**
```python
# 在代码中手动创建临时 token
from app.core.security import create_access_token
token = create_access_token(
    subject={"user_id": user.id, "token_version": user.token_version}
)
```

### Q: 前端无法连接后端？

**A:** 检查以下几点：
1. 后端服务是否启动（http://localhost:8000）
2. `.env.local` 中的 `NEXT_PUBLIC_API_URL` 是否正确
3. 浏览器控制台是否有 CORS 错误
4. 如果使用 Next.js Rewrites，检查 `next.config.js` 配置

### Q: 如何重置数据库？

```bash
# 方式1：删除数据库文件（最简单）
rm club_interview.db  # Linux/Mac
del club_interview.db  # Windows

# 然后重新执行迁移
alembic upgrade head

# 方式2：使用 Alembic 回滚
alembic downgrade base
alembic upgrade head
```

### Q: 如何查看 SQL 语句？

在 `.env` 中设置：
```env
DEBUG=true
```
SQL 语句将在控制台输出。

### Q: 如何修改 JWT 过期时间？

修改 `app/core/config.py`：
```python
jwt_expire_minutes: int = Field(60 * 24)  # 1天
access_token_expire_minutes: int = 30
```

### Q: 如何实现令牌吊销（强制登出）？

**A:** 在需要强制登出的地方（修改密码、账号禁用）：
```python
user.token_version += 1
session.commit()
```
所有旧 token 因版本不匹配自动失效。

### Q: 账号初始化接口需要认证，未初始化用户怎么拿到 token？

**A:** 两种方案：
1. **开发环境**：手动创建临时 token（见上文）
2. **生产环境**：通过短信验证码或其他认证方式，生成一次性初始化 token

## 8. 数据库文件位置

SQLite 数据库文件会保存在项目根目录：
- 默认文件名：`club_interview.db`
- 可在 `.env` 中通过 `DB_NAME` 修改文件名

**建议**：将 `.db` 文件添加到 `.gitignore`，避免提交到版本控制。

